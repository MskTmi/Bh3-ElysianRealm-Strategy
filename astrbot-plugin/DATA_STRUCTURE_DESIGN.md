# 数据结构设计说明

## 问题分析

根据您的需求：

1. **每隔 40 天会更新的图片攻略**：攻略不是全部更新，而是更新其中一个或几个角色
2. **唤醒词定义困难**：希望有一个主唤醒词，但发送的是最近更新的攻略
3. **是否需要更改数据结构**：需要更好地支持增量更新

## 解决方案

### 1. 新的数据结构

**旧格式**：
```yaml
Felis:
  - 帕朵乐土
  - 猫猫乐土
  - 帕朵菲利丝乐土
```

**新格式**：
```yaml
Felis:
  keywords:
    - 帕朵乐土
    - 猫猫乐土
    - 帕朵菲利丝乐土
  last_updated: '2024-01-15T10:30:00'  # ISO 8601 格式时间戳
```

### 2. 数据结构优势

#### 优点：

1. **支持增量更新追踪**
   - 每次 `git pull` 时自动检测哪些文件发生了变化
   - 只更新变化文件对应的时间戳
   - 保留历史更新记录

2. **主唤醒词功能**
   - 使用 "最新攻略"、"最新乐土攻略" 或 "最新乐土" 作为主唤醒词
   - 自动返回 `last_updated` 最新的攻略
   - 用户无需记住具体角色名称

3. **向后兼容**
   - 自动迁移旧格式配置到新格式
   - 保留所有现有触发词
   - 对于旧配置，`last_updated` 初始值为 `null`

4. **可扩展性**
   - 未来可以添加更多元数据（如攻略版本号、作者等）
   - 不影响现有功能

#### 缺点：

1. **配置文件稍大**：增加了时间戳字段
2. **需要 Git**：依赖 `git diff` 检测文件变化（但原本就需要 Git）

### 3. 工作流程

```
用户: /更新乐土攻略
 ↓
系统: git pull
 ↓
系统: git diff 检测变化的文件
 ↓
系统: 更新对应角色的 last_updated 时间戳
 ↓
系统: 保存配置并提示用户哪些角色更新了
 ↓
用户: 最新攻略
 ↓
系统: 查找 last_updated 最新的角色
 ↓
系统: 发送该角色的攻略图片
```

### 4. 使用场景示例

#### 场景 1：定期更新
```
# 每次版本更新（约 40 天）
用户: /更新乐土攻略
机器人: 乐土攻略更新完成
       更新的角色: Felis, Human
       [请]使用'/乐土指令 添加 [imageName] [command]'为新角色添加触发词
       或使用 '最新攻略' 查看最新更新的攻略
```

#### 场景 2：查看最新攻略
```
用户: 最新攻略
机器人: 最新更新的攻略：猫猫乐土 (更新于 2024-01-15)
       [发送帕朵菲利丝攻略图片]
```

#### 场景 3：查看所有攻略
```
用户: /乐土指令 列表
机器人: 攻略列表:
       
       Felis: 帕朵乐土, 猫猫乐土 (更新于: 2024-01-15)
       Human: 人律乐土, 爱律乐土 (更新于: 2024-01-10)
       Void: 空律乐土, 女王乐土
       ...
```

### 5. 实现细节

#### 时间戳格式
使用 ISO 8601 格式：`YYYY-MM-DDTHH:MM:SS`
- 标准化、易于解析
- Python 原生支持 `datetime.fromisoformat()`
- 字符串比较即可判断先后

#### 检测更新逻辑
```python
# 获取更新前的提交哈希
old_commit = git rev-parse HEAD

# 拉取更新
git pull

# 获取变化的文件
changed_files = git diff --name-only old_commit HEAD

# 筛选图片文件
for file in changed_files:
    if is_image_file(file):
        character_name = get_character_name(file)
        update_timestamp(character_name)
```

#### 查找最新攻略
```python
latest_char = None
latest_time = None

for char_name, config in strategy_config.items():
    if config["last_updated"]:
        if latest_time is None or config["last_updated"] > latest_time:
            latest_time = config["last_updated"]
            latest_char = char_name

return latest_char
```

## 总结

### 回答您的问题：

1. **需要更改数据结构吗？**
   - ✅ 是的，新结构更适合您的需求

2. **有更好的结构吗？**
   - ✅ 新结构支持时间戳追踪，完美适配 40 天更新周期

3. **主唤醒词？**
   - ✅ 实现了"最新攻略"主唤醒词，自动返回最近更新的内容

### 额外优势：

- 🔄 **自动化**：无需手动管理更新记录
- 📊 **可视化**：列表命令显示更新时间
- 🔙 **兼容性**：自动迁移旧配置
- 🎯 **用户友好**：主唤醒词让用户无需记住复杂名称

### 升级建议：

如果您有其他需求，可以考虑进一步扩展：

1. **版本号追踪**：记录每个攻略的版本号
2. **变更日志**：记录每次更新的内容
3. **多版本支持**：保留历史版本攻略
4. **统计功能**：追踪攻略查询次数
5. **自动提醒**：有新攻略时自动通知用户

但根据当前需求，现有方案已经足够且高效。
